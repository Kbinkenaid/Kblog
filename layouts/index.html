{{ define "main" }}
  <article class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy nested-links {{ $.Param "text_color" | compare.Default "mid-gray" }}">
    {{ .Content }}
  </article>

  {{/* Define a section to pull recent posts from. For Hugo 0.20 this will default to the section with the most number of pages. */}}
  {{ $mainSections := site.Params.mainSections | compare.Default (collections.Slice "post") }}
  {{ $show_recent_posts := site.Params.ananke.show_recent_posts }}
  {{ $section := collections.Where $.Site.RegularPages "Section" "in" $mainSections }}
  {{ $section_count := len $section }}

  {{ if and ($show_recent_posts) (compare.Ge $section_count 1) }}
    <div class="pa3 pa4-ns w-100 center">
      <section class="w-100 mw8 center">
        <h2 class="f2 fw6 tc mb4 dark-gray">Latest Posts</h2>
        <div class="flex flex-wrap justify-center">
          {{/* Range through all posts in the section */}}
          {{ range $section }}
            <div class="w-100 w-45-ns ma2 mb4 relative bg-white ba b--light-gray br3 shadow-4 hover-shadow-5 transition-all">
              <article class="pa4">
                <header class="mb3">
                  <h3 class="f4 fw6 near-black mb2 lh-title">
                    <a href="{{ .RelPermalink }}" class="link dark-gray hover-black transition-colors">
                      {{ .Title }}
                    </a>
                  </h3>
                  <time class="f6 gray db mb2" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
                    {{ .Date.Format "January 2, 2006" }}
                  </time>
                </header>
                <div class="nested-links f5 lh-copy nested-copy-line-height gray mb3">
                  {{ .Summary }}
                </div>
                <footer>
                  <a href="{{.RelPermalink}}" class="f6 link dim br2 ph3 pv2 mb2 dib white bg-dark-gray hover-bg-black transition-colors">
                    Read More →
                  </a>
                </footer>
              </article>
            </div>
          {{ end }}
        </div>
      </section>
    </div>
  {{ end }}
  
  {{/* Newsletter Signup Section */}}
  <section class="w-100 mw8 center pa3 pa4-ns">
    <div class="bg-white ba b--light-gray br3 shadow-2 pa4 tc">
      <h3 class="f3 fw6 dark-gray mb3">Stay Updated</h3>
      <p class="f5 gray mb4 lh-copy measure center">Get notified when I publish new posts about cybersecurity, automation, and tech insights.</p>
      
      <form id="newsletter-form" class="mw6 center">
        <div class="flex flex-column flex-row-ns items-center justify-center">
          <input 
            type="email" 
            name="email" 
            placeholder="Enter your email address" 
            required
            class="input-reset ba b--light-gray pa3 mb3 mb0-ns mr3-ns w-100 w-60-ns br2 f5"
            id="email-input"
          >
          <button 
            type="submit" 
            class="f5 link dim br2 ph4 pv3 mb2 dib white bg-dark-gray hover-bg-black transition-colors bn pointer w-100 w-auto-ns"
            id="subscribe-btn"
          >
            Subscribe
          </button>
        </div>
      </form>
      
      <div id="form-message" class="dn mt3"></div>
    </div>
  </section>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('newsletter-form');
      const messageDiv = document.getElementById('form-message');
      const submitBtn = document.getElementById('subscribe-btn');
      
      if (form) {
          form.addEventListener('submit', async function(e) {
              e.preventDefault();
              
              const email = document.getElementById('email-input').value;
              
              submitBtn.textContent = 'Subscribing...';
              submitBtn.disabled = true;
              
              try {
                  // Submit to Formspree first, then trigger GitHub via webhook
                  const formspreeResponse = await fetch('https://formspree.io/f/xzzvwyzz', {
                      method: 'POST',
                      headers: {
                          'Accept': 'application/json',
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                          email: email,
                          _subject: 'New Blog Subscription'
                      })
                  });
                  
                  const response = formspreeResponse;
                  
                  if (response.ok) {
                      messageDiv.className = 'mt3 pa3 bg-light-green dark-green br2';
                      messageDiv.textContent = '✅ Thanks for subscribing! You\'ll get notified of new posts.';
                      form.reset();
                  } else {
                      throw new Error('Subscription failed');
                  }
                  
              } catch (error) {
                  console.error('Subscription error:', error);
                  messageDiv.className = 'mt3 pa3 bg-light-red dark-red br2';
                  messageDiv.textContent = '❌ Something went wrong. Please try again.';
              } finally {
                  submitBtn.textContent = 'Subscribe';
                  submitBtn.disabled = false;
              }
          });
      }
  });
  </script>
{{ end }}